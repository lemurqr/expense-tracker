{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Dashboard</h2>
  <form method="get" class="inline-form">
    <label>Month <input type="month" name="month" value="{{ selected_month }}"></label>
    <label>Start date <input type="date" name="start" value="{{ start_date or '' }}"></label>
    <label>End date <input type="date" name="end" value="{{ end_date or '' }}"></label>
    <button type="submit">Apply</button>
    <button type="submit" name="preset" value="this_month">This month</button>
    <button type="submit" name="preset" value="last_month">Last month</button>
    <button type="submit" name="preset" value="last_3_months">Last 3 months</button>
    <button type="submit" name="preset" value="ytd">YTD</button>
    <a class="button" href="{{ url_for('export_csv', month=selected_month, start=start_date, end=end_date) }}">Export CSV</a>
  </form>
  <p><small>Period: {{ period_label }}</small></p>
  <p><strong>Total spending (includes Personal, excludes Transfers):</strong> ${{ '%.2f'|format(total) }}</p>
  <p><strong>Shared spending (excludes Personal + Transfers):</strong> ${{ '%.2f'|format(shared_total) }}</p>
</section>

<section class="card">
  <h3>Household Settlement</h3>

  <details id="shared-expenses-section" open>
    <summary><strong>Shared Expenses</strong></summary>
    <table>
      <thead><tr><th>Metric</th><th>Value</th></tr></thead>
      <tbody>
        <tr><td>Period</td><td>{{ start_date or selected_month or 'All time' }}{% if end_date %} → {{ end_date }}{% endif %}</td></tr>
        <tr><td>Total shared expenses (DK+YZ)</td><td>${{ '%.2f'|format(settlement.total_shared) }}</td></tr>
        <tr><td>DK paid (shared)</td><td>${{ '%.2f'|format(settlement.dk_paid_shared) }}</td></tr>
        <tr><td>YZ paid (shared)</td><td>${{ '%.2f'|format(settlement.yz_paid_shared) }}</td></tr>
        <tr><td>Each share (50/50)</td><td>${{ '%.2f'|format(settlement.each_share) }}</td></tr>
        <tr>
          <td>Shared settlement</td>
          <td>
            {% if settlement.shared_delta < 0 %}
              DK→YZ ${{ '%.2f'|format(settlement.shared_delta|abs) }}
            {% elif settlement.shared_delta > 0 %}
              YZ→DK ${{ '%.2f'|format(settlement.shared_delta) }}
            {% else %}
              $0.00
            {% endif %}
          </td>
        </tr>
        <tr><td>Pet reimbursement (YZ→DK)</td><td>YZ→DK ${{ '%.2f'|format(settlement.pet_paid_by_dk) }}</td></tr>
        <tr>
          <td>Net settlement (this period)</td>
          <td>
            {% if settlement.period_net_delta < 0 %}
              DK→YZ ${{ '%.2f'|format(settlement.period_net_delta|abs) }}
            {% elif settlement.period_net_delta > 0 %}
              YZ→DK ${{ '%.2f'|format(settlement.period_net_delta) }}
            {% else %}
              $0.00
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </details>

  <h4>Balance & Repayments</h4>
  <table>
    <thead><tr><th>Line</th><th>Description</th><th>Amount</th></tr></thead>
    <tbody>
      <tr><td>1</td><td>Opening balance (before period)</td><td>{{ '%+.2f'|format(settlement.opening_balance) }}</td></tr>
      <tr><td>2</td><td>Net settlement delta from expenses (this period)</td><td>{{ '%+.2f'|format(settlement.period_net_delta) }}</td></tr>
      <tr><td>3</td><td>Repayments DK→YZ (this period)</td><td>${{ '%.2f'|format(settlement.repayments_dk_to_yz) }}</td></tr>
      <tr><td>4</td><td>Repayments YZ→DK (this period)</td><td>${{ '%.2f'|format(settlement.repayments_yz_to_dk) }}</td></tr>
      <tr><td>5</td><td>Closing balance (life-to-date)</td><td>{{ '%+.2f'|format(settlement.closing_balance) }}</td></tr>
      <tr><td>6</td><td>Current outstanding: DK owes</td><td>${{ '%.2f'|format(settlement.dk_owes_now) }}</td></tr>
      <tr><td>7</td><td>Current outstanding: YZ owes</td><td>${{ '%.2f'|format(settlement.yz_owes_now) }}</td></tr>
    </tbody>
  </table>

  <h4>Record repayment</h4>
  <form method="post" action="{{ url_for('create_settlement_payment') }}" class="inline-form">
    <input type="hidden" name="month" value="{{ selected_month }}">
    <input type="hidden" name="start" value="{{ start_date or '' }}">
    <input type="hidden" name="end" value="{{ end_date or '' }}">
    <label>Date <input type="date" name="date" required></label>
    <label>From
      <select name="from_person" required>
        <option value="DK">DK</option>
        <option value="YZ">YZ</option>
      </select>
    </label>
    <label>To
      <select name="to_person" required>
        <option value="YZ">YZ</option>
        <option value="DK">DK</option>
      </select>
    </label>
    <label>Amount <input type="number" step="0.01" min="0.01" name="amount" required></label>
    <label>Note <input type="text" name="note"></label>
    <button type="submit">Record repayment</button>
  </form>

  <table>
    <thead><tr><th>Date</th><th>From</th><th>To</th><th>Amount</th><th>Note</th><th>Action</th></tr></thead>
    <tbody>
      {% for repayment in repayments %}
      <tr>
        <td>{{ repayment.date }}</td>
        <td>{{ repayment.from_person }}</td>
        <td>{{ repayment.to_person }}</td>
        <td>${{ '%.2f'|format(repayment.amount) }}</td>
        <td>{{ repayment.note or '' }}</td>
        <td>
          <form method="post" action="{{ url_for('delete_settlement_payment', payment_id=repayment.id) }}" class="inline-form">
            <input type="hidden" name="month" value="{{ selected_month }}">
            <input type="hidden" name="start" value="{{ start_date or '' }}">
            <input type="hidden" name="end" value="{{ end_date or '' }}">
            <button type="submit">Delete</button>
          </form>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">No repayments in selected period.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <details id="monthly-breakdown-section">
    <summary><strong>Monthly Breakdown</strong></summary>
    <table>
      <thead>
        <tr>
          <th>Month (YYYY-MM)</th>
          <th>Total Expenses (DK+YZ)</th>
          <th>DK owes</th>
          <th>YZ owes</th>
          <th>DK paid (shared)</th>
          <th>YZ paid (shared)</th>
          <th>Each share</th>
          <th>Repayments DK→YZ</th>
          <th>Repayments YZ→DK</th>
          <th>Net delta</th>
          <th>Running balance</th>
        </tr>
      </thead>
      <tbody>
        {% for row in settlement.monthly_breakdown %}
        <tr>
          <td>{{ row.month }}</td>
          <td>${{ '%.2f'|format(row.total_expenses) }}</td>
          <td>${{ '%.2f'|format(row.dk_owes) }}</td>
          <td>${{ '%.2f'|format(row.yz_owes) }}</td>
          <td>${{ '%.2f'|format(row.dk_paid_shared) }}</td>
          <td>${{ '%.2f'|format(row.yz_paid_shared) }}</td>
          <td>${{ '%.2f'|format(row.each_share) }}</td>
          <td>${{ '%.2f'|format(row.repayments_dk_to_yz) }}</td>
          <td>${{ '%.2f'|format(row.repayments_yz_to_dk) }}</td>
          <td>{{ '%+.2f'|format(row.net_delta) }}</td>
          <td>{{ '%+.2f'|format(row.running_balance) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="11">No data in selected period.</td></tr>
        {% endfor %}
        <tr>
          <td><strong>Total</strong></td>
          <td><strong>${{ '%.2f'|format(settlement.monthly_totals.total_expenses) }}</strong></td>
          <td><strong>${{ '%.2f'|format(settlement.monthly_totals.dk_owes) }}</strong></td>
          <td><strong>${{ '%.2f'|format(settlement.monthly_totals.yz_owes) }}</strong></td>
          <td></td><td></td><td></td>
          <td><strong>${{ '%.2f'|format(settlement.monthly_totals.repayments_dk_to_yz) }}</strong></td>
          <td><strong>${{ '%.2f'|format(settlement.monthly_totals.repayments_yz_to_dk) }}</strong></td>
          <td><strong>{{ '%+.2f'|format(settlement.monthly_totals.net_delta) }}</strong></td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </details>
</section>

<section class="grid-two">
  <div class="card">
    <h3>Monthly Summary</h3>
    <ul>
      {% for row in summary %}
      <li>{{ row.category }}: ${{ '%.2f'|format(row.total) }}</li>
      {% else %}
      <li>No expenses for this period.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="card">
    <h3>Transactions</h3>
    <form method="post" action="{{ url_for('bulk_expense_action') }}" id="bulk-actions-form">
      <input type="hidden" name="month" value="{{ selected_month }}">
      <input type="hidden" name="start" value="{{ start_date or '' }}">
      <input type="hidden" name="end" value="{{ end_date or '' }}">
      <div id="bulk-actions-bar" class="bulk-actions-bar" hidden>
        <strong>Selected: <span id="selected-count">0</span></strong>
        <button type="submit" name="action" value="delete" id="bulk-delete-button">Delete selected</button>
        <label>Set category
          <select name="category_id">
            <option value="">Choose category</option>
            {% for category in all_categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="submit" name="action" value="set_category">Apply</button>
        <label>Set paid by
          <select name="paid_by">
            <option value="">Blank</option>
            <option value="DK">DK</option>
            <option value="YZ">YZ</option>
          </select>
        </label>
        <button type="submit" name="action" value="set_paid_by">Apply</button>
        <label>
          <input type="checkbox" name="is_transfer" value="1">
          Mark as transfer
        </label>
        <button type="submit" name="action" value="set_transfer">Apply</button>
      </div>

      <table>
        <thead>
        <tr><th><input type="checkbox" id="select-all-expenses" aria-label="Select all on page"></th><th>Date</th><th>Amount</th><th>Paid by</th><th>Category</th><th>Description</th><th>Confidence</th><th>Source</th><th>Actions</th></tr>
        </thead>
        <tbody>
        {% for expense in expenses %}
        <tr>
          <td><input type="checkbox" class="expense-checkbox" name="selected_ids" value="{{ expense.id }}" aria-label="Select expense {{ expense.id }}"></td>
          <td>{{ expense.date }}</td>
          <td>${{ '%.2f'|format(expense.amount) }}</td>
          <td>{{ expense.paid_by or '—' }}</td>
          <td>{{ expense.category or 'Uncategorized' }}</td>
          <td>{{ expense.description }}</td>
          <td>
            {% if expense.category_source == 'transfer' %}
              <span class="confidence-badge confidence-transfer">Transfer</span>
            {% elif expense.category_confidence is not none %}
              {% if expense.category_confidence >= 80 %}
                <span class="confidence-badge confidence-high">{{ expense.category_confidence }}</span>
              {% elif expense.category_confidence >= 50 %}
                <span class="confidence-badge confidence-medium">{{ expense.category_confidence }}</span>
              {% else %}
                <span class="confidence-badge confidence-low">{{ expense.category_confidence }}</span>
              {% endif %}
            {% else %}
              <span class="confidence-badge confidence-low">N/A</span>
            {% endif %}
          </td>
          <td><small>{{ expense.category_source or 'unknown' }}</small></td>
          <td>
            <a href="{{ url_for('expense_detail', expense_id=expense.id) }}">Details</a>
            <a href="{{ url_for('edit_expense', expense_id=expense.id, month=selected_month, start=start_date, end=end_date) }}">Edit</a>
            <form method="post" action="{{ url_for('bulk_expense_action') }}" class="inline-form" onsubmit="return confirm('Delete this transaction?');">
              <input type="hidden" name="month" value="{{ selected_month }}">
              <input type="hidden" name="start" value="{{ start_date or '' }}">
              <input type="hidden" name="end" value="{{ end_date or '' }}">
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="selected_ids" value="{{ expense.id }}">
              <button type="submit">Delete</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="9">No expenses added yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </form>
  </div>
  <script>
    (function () {
      const form = document.getElementById('bulk-actions-form');
      const selectAll = document.getElementById('select-all-expenses');
      const checkboxes = form ? Array.from(form.querySelectorAll('.expense-checkbox')) : [];
      const bar = document.getElementById('bulk-actions-bar');
      const countEl = document.getElementById('selected-count');
      const deleteButton = document.getElementById('bulk-delete-button');

      function syncSelection() {
        if (!form) return;
        const selected = checkboxes.filter((box) => box.checked).length;
        countEl.textContent = String(selected);
        bar.hidden = selected === 0;
        if (selectAll) {
          selectAll.checked = checkboxes.length > 0 && selected === checkboxes.length;
          selectAll.indeterminate = selected > 0 && selected < checkboxes.length;
        }
      }

      if (selectAll) {
        selectAll.addEventListener('change', function () {
          checkboxes.forEach((box) => {
            box.checked = selectAll.checked;
          });
          syncSelection();
        });
      }

      checkboxes.forEach((box) => box.addEventListener('change', syncSelection));
      if (deleteButton) {
        deleteButton.addEventListener('click', function (event) {
          if (!window.confirm('Delete selected transactions?')) {
            event.preventDefault();
          }
        });
      }
      syncSelection();

      ['shared-expenses-section', 'monthly-breakdown-section'].forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const key = `collapse:${id}`;
        const stored = localStorage.getItem(key);
        if (stored === 'open') el.open = true;
        if (stored === 'closed') el.open = false;
        el.addEventListener('toggle', function () {
          localStorage.setItem(key, el.open ? 'open' : 'closed');
        });
      });
    })();
  </script>
</section>
{% endblock %}
