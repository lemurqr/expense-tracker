{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Import CSV</h2>
  <p>Upload a bank CSV with or without headers. CIBC-style headerless files are supported.</p>
  <form method="post" enctype="multipart/form-data" class="stack-form">
    <label>CSV file
      <input type="file" name="csv_file" accept=".csv" required>
    </label>

    <h3>Column Mapping</h3>
    <div class="grid-two">
      <label>Date
        <select name="map_date">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.date == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Description
        <select name="map_description">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.description == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Amount
        <select name="map_amount">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.amount == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Debit
        <select name="map_debit">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.debit == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Credit
        <select name="map_credit">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.credit == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Category (optional)
        <select name="map_category">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.category == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>
    </div>

    <button type="submit" name="action" value="preview">Preview Import</button>
  </form>
</section>

{% if detected_mode %}
<section class="card">
  <h3>Preview (first 20 rows)</h3>
  <p>Detected format: <strong>{{ detected_mode }}</strong></p>
  {% if preview_rows %}
  <form method="post">
    <table>
      <thead>
        <tr><th>Date</th><th>Amount</th><th>Description</th><th>Category</th></tr>
      </thead>
      <tbody>
        {% for row in preview_rows %}
        <tr>
          <td>{{ row.date }}</td>
          <td>{{ '%.2f'|format(row.amount) }}</td>
          <td>{{ row.description }}</td>
          <td>
            <select name="override_category_{{ loop.index0 }}">
              <option value="">Use suggested ({{ row.category or 'Uncategorized' }})</option>
              {% for category in categories %}
              <option value="{{ category.name }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <input type="hidden" name="action" value="confirm">
    <input type="hidden" name="parsed_rows" value='{{ parsed_rows_json|safe }}'>
    <button type="submit">Confirm Import</button>
  </form>
  {% else %}
    <p>No importable rows found with current mapping.</p>
  {% endif %}
</section>
{% endif %}
{% endblock %}
