{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Import CSV</h2>
  <p>Upload a bank CSV with or without headers. CIBC-style headerless files are supported.</p>
  <form method="post" enctype="multipart/form-data" class="stack-form">
    <label>CSV file
      <input type="file" name="csv_file" accept=".csv" required>
    </label>

    <h3>Column Mapping</h3>
    <div class="grid-two">
      <label>Date
        <select name="map_date">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.date == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Description
        <select name="map_description">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.description == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Amount
        <select name="map_amount">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.amount == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Debit
        <select name="map_debit">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.debit == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Credit
        <select name="map_credit">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.credit == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Vendor (optional)
        <select name="map_vendor">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.vendor == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Category (optional)
        <select name="map_category">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.category == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>
    </div>

    <button type="submit" name="action" value="preview">Preview Import</button>
  </form>
</section>

{% if detected_mode %}
<section class="card">
  <h3>Preview (first 20 rows)</h3>
  <p class="legend-text">Legend: <span class="confidence-badge confidence-high">High</span> = high confidence, <span class="confidence-badge confidence-medium">Medium</span> = review, <span class="confidence-badge confidence-low">Low</span> = needs review.</p>
  <p>Detected format: <strong>{{ detected_mode }}</strong></p>
  {% if auto_mapping_applied %}
  <p><small>Auto-mapped CIBC headerless format: Date=1, Desc=2, Debit=3, Credit=4 (ignored extra columns).</small></p>
  {% endif %}
  {% if preview_rows %}
  <form method="post">
    <label class="inline-form"><input type="checkbox" id="lowConfidenceToggle"> Show only low-confidence (&lt; 80)</label>
    <table>
      <thead>
        <tr><th>Date</th><th>Amount</th><th>Description</th><th>Vendor</th><th>Suggested Category</th><th>Confidence</th><th>Source</th></tr>
      </thead>
      <tbody>
        {% for row in preview_rows %}
        <tr class="preview-row" data-confidence="{{ row.confidence }}" data-vendor-normalized="{{ (row.vendor or '')|lower|replace('"', '') }}">
          <td>{{ row.date }}</td>
          <td>{{ '%.2f'|format(row.amount) }}</td>
          <td>{{ row.description }}</td>
          <td><input name="override_vendor_{{ loop.index0 }}" value="{{ row.vendor or "" }}"></td>
          <td>
            <select name="override_category_{{ loop.index0 }}">
              <option value="">Use suggested ({{ row.category or 'Uncategorized' }})</option>
              {% for category in categories %}
              <option value="{{ category.name }}">{{ category.name }}</option>
              {% endfor %}
            </select>
            <label class="inline-form apply-all-vendor-option" hidden>
              <input type="checkbox" class="apply-category-to-vendor" data-index="{{ loop.index0 }}">
              Apply this category to all rows with same normalized vendor in this preview.
            </label>
          </td>
          <td>
            {% if row.suggested_source == 'transfer' %}
              <span class="confidence-badge confidence-transfer">Transfer</span>
            {% elif row.confidence >= 80 %}
              <span class="confidence-badge confidence-high">{{ row.confidence }} ({{ row.confidence_label }})</span>
            {% elif row.confidence >= 50 %}
              <span class="confidence-badge confidence-medium">{{ row.confidence }} ({{ row.confidence_label }})</span>
            {% else %}
              <span class="confidence-badge confidence-low">{{ row.confidence }} ({{ row.confidence_label }})</span>
            {% endif %}
          </td>
          <td><small>{{ row.suggested_source }}</small></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <input type="hidden" name="action" value="confirm">
    <input type="hidden" name="parsed_rows" value='{{ parsed_rows_json|safe }}'>
    <input type="hidden" name="map_date" value="{{ mapping.date }}">
    <input type="hidden" name="map_description" value="{{ mapping.description }}">
    <input type="hidden" name="map_amount" value="{{ mapping.amount }}">
    <input type="hidden" name="map_debit" value="{{ mapping.debit }}">
    <input type="hidden" name="map_credit" value="{{ mapping.credit }}">
    <input type="hidden" name="map_vendor" value="{{ mapping.vendor }}">
    <input type="hidden" name="map_category" value="{{ mapping.category }}">
    <input type="hidden" name="has_header" value="{{ 1 if has_header else 0 }}">
    <input type="hidden" name="detected_format" value="{{ detected_format or '' }}">
    <button type="submit">Confirm Import</button>
  </form>
  {% else %}
    <p>No importable rows found with current mapping.</p>
  {% endif %}
</section>
{% endif %}

<script>
  const normalizePreviewVendor = (value) => {
    return (value || '')
      .toLowerCase()
      .replace(/[^\w\s/]/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
  };

  const applyCategoryToMatchingVendors = (sourceSelect) => {
    const sourceRow = sourceSelect.closest('.preview-row');
    if (!sourceRow) {
      return;
    }

    const sourceCategory = sourceSelect.value;
    const sourceVendorInput = sourceRow.querySelector('input[name^="override_vendor_"]');
    const normalizedVendor = normalizePreviewVendor(sourceVendorInput ? sourceVendorInput.value : '');

    if (!sourceCategory || !normalizedVendor) {
      return;
    }

    document.querySelectorAll('.preview-row').forEach((row) => {
      const vendorInput = row.querySelector('input[name^="override_vendor_"]');
      const rowVendor = normalizePreviewVendor(vendorInput ? vendorInput.value : '');
      if (rowVendor !== normalizedVendor) {
        return;
      }
      const categorySelect = row.querySelector('select[name^="override_category_"]');
      if (categorySelect) {
        categorySelect.value = sourceCategory;
        toggleApplyAllOption(categorySelect);
      }
    });
  };

  const toggleApplyAllOption = (categorySelect) => {
    const row = categorySelect.closest('.preview-row');
    if (!row) {
      return;
    }
    const option = row.querySelector('.apply-all-vendor-option');
    const checkbox = row.querySelector('.apply-category-to-vendor');
    if (!option || !checkbox) {
      return;
    }

    if (categorySelect.value) {
      option.hidden = false;
    } else {
      option.hidden = true;
      checkbox.checked = false;
    }
  };

  document.querySelectorAll('select[name^="override_category_"]').forEach((select) => {
    toggleApplyAllOption(select);
    select.addEventListener('change', () => {
      toggleApplyAllOption(select);
    });
  });

  document.querySelectorAll('.apply-category-to-vendor').forEach((checkbox) => {
    checkbox.addEventListener('change', (event) => {
      if (!event.target.checked) {
        return;
      }

      const row = event.target.closest('.preview-row');
      if (!row) {
        return;
      }
      const sourceSelect = row.querySelector('select[name^="override_category_"]');
      if (!sourceSelect) {
        return;
      }

      applyCategoryToMatchingVendors(sourceSelect);
      event.target.checked = false;
    });
  });

  const lowConfidenceToggle = document.getElementById('lowConfidenceToggle');
  if (lowConfidenceToggle) {
    lowConfidenceToggle.addEventListener('change', (event) => {
      document.querySelectorAll('.preview-row').forEach((row) => {
        const confidence = parseInt(row.dataset.confidence || '0', 10);
        const shouldHide = event.target.checked && confidence >= 80;
        row.style.display = shouldHide ? 'none' : '';
      });
    });
  }
</script>
{% endblock %}
