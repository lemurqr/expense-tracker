{% extends 'base.html' %}
{% block content %}
<section class="card">
  <h2>Import CSV</h2>
  <p>Upload a bank CSV with or without headers. CIBC-style headerless files are supported.</p>
  <form method="post" enctype="multipart/form-data" class="stack-form">
    <label>CSV file
      <input type="file" name="csv_file" accept=".csv" required>
    </label>

    <h3>Column Mapping</h3>
    <div class="grid-two">
      <label>Date
        <select name="map_date">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.date == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Description
        <select name="map_description">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.description == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Amount
        <select name="map_amount">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.amount == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Debit
        <select name="map_debit">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.debit == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Credit
        <select name="map_credit">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.credit == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Vendor (optional)
        <select name="map_vendor">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.vendor == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Category (optional)
        <select name="map_category">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.category == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>


      <label>Paid by (optional)
        <select name="map_paid_by">
          <option value="">-- Select --</option>
          {% for idx in range(columns|length) %}
          <option value="{{ idx }}" {% if mapping.paid_by == idx|string %}selected{% endif %}>{{ columns[idx] }}</option>
          {% endfor %}
        </select>
      </label>
    </div>

    <button type="submit" name="action" value="preview">Preview Import</button>
  </form>
</section>

{% if detected_mode %}
<section class="card">
  <h3>Preview</h3>
  <p>Showing {{ displayed_rows_count }} of {{ total_rows_count }} rows</p>
  <form method="get" class="inline-form">
    <input type="hidden" name="import_id" value="{{ preview_id }}">
    <label class="inline-form">
      <input type="checkbox" name="show_all" value="1" {% if show_all_rows %}checked{% endif %} onchange="this.form.submit()">
      Show all rows
    </label>
    {% if requires_show_all_confirmation %}
    <label class="inline-form">
      <input type="checkbox" name="confirm_show_all" value="1">
      Confirm show all rows ({{ total_rows_count }} rows)
    </label>
    <small>Large previews may be slow.</small>
    {% endif %}
  </form>
  <p class="legend-text">Legend: <span class="confidence-badge confidence-high">High</span> = high confidence, <span class="confidence-badge confidence-medium">Medium</span> = review, <span class="confidence-badge confidence-low">Low</span> = needs review.</p>
  <p>Detected format: <strong>{{ detected_mode }}</strong> · detected_format: <strong>{{ detected_format or 'n/a' }}</strong>{% if header_row_index is not none %} · header_row_index: <strong>{{ header_row_index }}</strong>{% endif %}{% if skipped_rows %} · skipped_rows: <strong>{{ skipped_rows }}</strong>{% endif %}</p>
  <p><small>auto_mapped_fields: date=<strong>{{ auto_mapped_fields.date if auto_mapped_fields else 'None' }}</strong>, description=<strong>{{ auto_mapped_fields.description if auto_mapped_fields else 'None' }}</strong>, amount=<strong>{{ auto_mapped_fields.amount if auto_mapped_fields else 'None' }}</strong>, vendor=<strong>{{ auto_mapped_fields.vendor if auto_mapped_fields else 'None' }}</strong>, debit=<strong>{{ auto_mapped_fields.debit if auto_mapped_fields else 'None' }}</strong>, credit=<strong>{{ auto_mapped_fields.credit if auto_mapped_fields else 'None' }}</strong></small></p>
  {% if auto_mapping_applied %}
  <p><small>Auto-mapped CIBC headerless format: Date=1, Desc=2, Debit=3, Credit=4 (ignored extra columns).</small></p>
  {% endif %}
  {% if preview_rows %}
  <form method="post">
    <label>Paid by (default for this import)
      <select name="import_default_paid_by" id="importDefaultPaidBy">
        <option value="" {% if not import_default_paid_by %}selected{% endif %}>-- Select --</option>
        <option value="DK" {% if import_default_paid_by == 'DK' %}selected{% endif %}>DK</option>
        <option value="YZ" {% if import_default_paid_by == 'YZ' %}selected{% endif %}>YZ</option>
      </select>
    </label>
    <p><button type="button" id="fillPaidByFromDefault">Fill missing with default</button></p>
    <label class="inline-form"><input type="checkbox" id="lowConfidenceToggle"> Show only low-confidence (&lt; 80)</label>
    <table>
      <thead>
        <tr><th>Import</th><th>Date</th><th>Amount</th><th>Description</th><th>Vendor</th><th>Paid by</th><th>Suggested Category</th><th>Confidence</th><th>Source</th></tr>
      </thead>
      <tbody>
        {% for row in preview_rows %}
        <tr class="preview-row" data-row-index="{{ row.row_index }}" data-vendor-key="{{ row.vendor_key }}" data-vendor-rule-key="{{ row.vendor_rule_key }}" data-description-rule-key="{{ row.description_rule_key }}" data-confidence="{{ row.confidence }}">
          <td><input type="checkbox" class="row-check" checked></td>
          <td>{{ row.date }}</td>
          <td>{{ '%.2f'|format(row.amount) }}</td>
          <td>{{ row.description }}</td>
          <td><input name="override_vendor_{{ row.row_index }}" value="{{ row.vendor or "" }}"></td>
          <td>
            <select name="override_paid_by_{{ row.row_index }}" class="paid-by-select">
              <option value="" {% if not row.paid_by %}selected{% endif %}>-- Select --</option>
              <option value="DK" {% if row.paid_by == 'DK' %}selected{% endif %}>DK</option>
              <option value="YZ" {% if row.paid_by == 'YZ' %}selected{% endif %}>YZ</option>
            </select>
          </td>
          <td>
            <select name="override_category_{{ row.row_index }}" class="category-select" data-original-category="{{ row.category or "" }}">
              <option value="" {% if not row.override_category %}selected{% endif %}>Use suggested ({{ row.category or 'Uncategorized' }})</option>
              {% for category in categories %}
              <option value="{{ category.name }}" {% if row.override_category == category.name %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
            <label class="inline-form apply-all-option" hidden>
              <input type="checkbox" class="apply-category-to-matching" data-index="{{ row.row_index }}">
              Apply to all matching rows in this preview
            </label>
            <label class="inline-form apply-all-match-type" hidden>
              Match by
              <select class="apply-match-type">
                <option value="vendor">vendor</option>
                <option value="description">description pattern</option>
              </select>
            </label>
          </td>
          <td>
            {% if row.suggested_source == 'transfer' %}
              <span class="confidence-badge confidence-transfer badge-transfer">Transfer</span>
            {% elif row.confidence >= 80 %}
              <span class="confidence-badge confidence-high badge-high">{{ row.confidence }} ({{ row.confidence_label }})</span>
            {% elif row.confidence >= 50 %}
              <span class="confidence-badge confidence-medium badge-medium">{{ row.confidence }} ({{ row.confidence_label }})</span>
            {% else %}
              <span class="confidence-badge confidence-low badge-low">{{ row.confidence }} ({{ row.confidence_label }})</span>
            {% endif %}
          </td>
          <td class="source-cell"><small>{{ row.suggested_source }}</small></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <input type="hidden" name="action" value="confirm">
    <input type="hidden" name="import_id" value="{{ preview_id }}">
    <input type="hidden" name="show_all_rows" value="{{ 1 if show_all_rows else 0 }}">
    <input type="hidden" name="map_date" value="{{ mapping.date }}">
    <input type="hidden" name="map_description" value="{{ mapping.description }}">
    <input type="hidden" name="map_amount" value="{{ mapping.amount }}">
    <input type="hidden" name="map_debit" value="{{ mapping.debit }}">
    <input type="hidden" name="map_credit" value="{{ mapping.credit }}">
    <input type="hidden" name="map_vendor" value="{{ mapping.vendor }}">
    <input type="hidden" name="map_category" value="{{ mapping.category }}">
    <input type="hidden" name="map_paid_by" value="{{ mapping.paid_by }}">
    <input type="hidden" name="has_header" value="{{ 1 if has_header else 0 }}">
    <input type="hidden" name="detected_format" value="{{ detected_format or '' }}">
    <input type="hidden" name="file_signature" value="{{ file_signature or '' }}">
    <p id="applyVendorMessage" class="legend-text"></p>
    <p class="legend-text">Rows with manual/bulk override are highlighted.</p>
    <button type="submit">Confirm Import</button>
  </form>
  {% else %}
    <p>No importable rows found with current mapping.</p>
  {% endif %}
</section>
{% endif %}

<script>
  const lowConfidenceToggle = document.getElementById('lowConfidenceToggle');
  const applyVendorMessage = document.getElementById('applyVendorMessage');
  const fillPaidByFromDefaultButton = document.getElementById('fillPaidByFromDefault');
  const importDefaultPaidBy = document.getElementById('importDefaultPaidBy');

  const badgeClassFor = (source, confidence) => {
    if (source === 'transfer') return ['confidence-transfer', 'badge-transfer'];
    if (confidence >= 80) return ['confidence-high', 'badge-high'];
    if (confidence >= 50) return ['confidence-medium', 'badge-medium'];
    return ['confidence-low', 'badge-low'];
  };

  const markRowOverridden = (row, isOverridden = true) => {
    if (!row) return;
    row.classList.toggle('overridden-row', isOverridden);
  };

  const toggleApplyAllOption = (categorySelect) => {
    const row = categorySelect.closest('.preview-row');
    if (!row) return;
    const option = row.querySelector('.apply-all-option');
    const matchTypeWrap = row.querySelector('.apply-all-match-type');
    const checkbox = row.querySelector('.apply-category-to-matching');
    if (!option || !checkbox || !matchTypeWrap) return;
    const hasValue = !!categorySelect.value;
    option.hidden = !hasValue;
    matchTypeWrap.hidden = !hasValue;
    if (!hasValue) checkbox.checked = false;
  };

  const showAppliedMessage = (count) => {
    if (!applyVendorMessage) return;
    applyVendorMessage.textContent = `Applied to ${count} rows`;
  };

  document.querySelectorAll('.category-select').forEach((select) => {
    toggleApplyAllOption(select);
    select.addEventListener('change', () => {
      toggleApplyAllOption(select);
      const row = select.closest('.preview-row');
      markRowOverridden(row, !!select.value);
    });
  });

  document.querySelectorAll('.apply-category-to-matching').forEach((checkbox) => {
    checkbox.addEventListener('change', async (event) => {
      if (!event.target.checked) return;
      const row = event.target.closest('.preview-row');
      const select = row ? row.querySelector('.category-select') : null;
      if (!row || !select || !select.value) {
        event.target.checked = false;
        return;
      }

      const matchTypeSelect = row.querySelector('.apply-match-type');
      const matchType = matchTypeSelect ? matchTypeSelect.value : 'vendor';
      const matchKey = matchType === 'description' ? (row.dataset.descriptionRuleKey || '') : (row.dataset.vendorRuleKey || row.dataset.vendorKey || '');
      const importIdInput = document.querySelector('input[name="import_id"]');
      const payload = { match_type: matchType, match_key: matchKey, category_name: select.value, import_id: importIdInput ? importIdInput.value : '' };
      const response = await fetch('/import/csv/apply_override', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        event.target.checked = false;
        return;
      }

      const result = await response.json();
      (result.updated_rows || []).forEach((updated) => {
        const target = document.querySelector(`.preview-row[data-row-index="${updated.row_index}"]`);
        if (!target) return;
        const rowCheck = target.querySelector('.row-check');
        const rowSelect = target.querySelector('.category-select');
        const badge = target.querySelector('.confidence-badge');
        const sourceCell = target.querySelector('.source-cell');

        if (rowCheck) rowCheck.checked = true;
        if (rowSelect) {
          rowSelect.value = updated.category;
          toggleApplyAllOption(rowSelect);
        }
        if (badge) {
          badge.classList.remove('confidence-high', 'confidence-medium', 'confidence-low', 'confidence-transfer', 'badge-high', 'badge-medium', 'badge-low', 'badge-transfer');
          const classes = badgeClassFor(updated.source, updated.confidence);
          badge.classList.add(classes[0], classes[1]);
          badge.textContent = updated.source === 'transfer' ? 'Transfer' : `${updated.confidence} (${updated.confidence_label})`;
        }
        if (sourceCell) sourceCell.innerHTML = `<small>${updated.source}</small>`;

        target.dataset.confidence = updated.confidence;
        markRowOverridden(target, true);
      });

      showAppliedMessage(result.updated_count || 0);
      event.target.checked = false;
    });
  });

  if (fillPaidByFromDefaultButton) {
    fillPaidByFromDefaultButton.addEventListener('click', () => {
      const value = importDefaultPaidBy ? importDefaultPaidBy.value : '';
      if (!value) return;
      document.querySelectorAll('.paid-by-select').forEach((select) => {
        if (!select.value) select.value = value;
      });
    });
  }

  if (lowConfidenceToggle) {
    lowConfidenceToggle.addEventListener('change', (event) => {
      document.querySelectorAll('.preview-row').forEach((row) => {
        const confidence = parseInt(row.dataset.confidence || '0', 10);
        row.style.display = event.target.checked && confidence >= 80 ? 'none' : '';
      });
    });
  }
</script>
{% endblock %}
